services:
  # StarRocks Frontend
  starrocks-fe:
    image: starrocks/fe-ubuntu:latest
    container_name: starrocks-fe
    hostname: starrocks-fe
    command:
      - /bin/bash
      - -c
      - |
        /opt/starrocks/fe/bin/start_fe.sh --daemon
        sleep 5
        tail -f /opt/starrocks/fe/log/fe.log
    ports:
      - "18030:8030" # HTTP port
      - "19020:9020" # RPC port
      - "19030:9030" # MySQL port
    environment:
      - TZ=UTC
    networks:
      - retail-analytics-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/api/health"]
      interval: 5s
      timeout: 5s
      retries: 30

  # StarRocks Backend
  starrocks-be:
    image: starrocks/be-ubuntu:latest
    container_name: starrocks-be
    hostname: starrocks-be
    command:
      - /bin/bash
      - -c
      - |
        mkdir -p /opt/starrocks/be/storage
        /opt/starrocks/be/bin/start_be.sh --daemon
        sleep 10
        tail -f /opt/starrocks/be/log/be.INFO
    ports:
      - "18040:8040" # HTTP port
      - "19040:9040" # BRPC port
      - "19050:9050" # Heartbeat port
      - "18060:8060" # Web server port
    environment:
      - TZ=UTC
    networks:
      - retail-analytics-net
    depends_on:
      - starrocks-fe

  starrocks-init:
    image: starrocks/fe-ubuntu:latest
    container_name: starrocks-init
    depends_on:
      starrocks-fe:
        condition: service_healthy
      starrocks-be:
        condition: service_started
    networks:
      - retail-analytics-net
    command: >
      /bin/bash -c "
      echo 'Waiting for StarRocks FE...';
      for i in {1..30}; do
        mysql -h starrocks-fe -P 9030 -u root -e 'SELECT 1' && break;
        echo 'Waiting...';
        sleep 2;
      done;
      echo 'Registering Backend...';
      mysql -h starrocks-fe -P 9030 -u root -e \"ALTER SYSTEM ADD BACKEND 'starrocks-be:9050';\";
      echo 'Backend registered.';
      "

networks:
  retail-analytics-net:
    driver: bridge

# No volumes needed for now (StarRocks storage is ephemeral in container or mapped manually if needed)
